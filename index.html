<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Minecraft Work Manager</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(135deg,#141e30,#243b55);
  color:white;
  text-align:center;
}
.container{padding:40px;}
button{
  padding:10px 20px;
  margin:6px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
}
.primary{background:#00c6ff;color:black;}
.danger{background:#ff4e50;color:white;}
.adminBtn{background:#ffd700;color:black;}
.card{
  background:rgba(255,255,255,0.08);
  padding:20px;
  border-radius:12px;
  margin-top:20px;
}
.hidden{display:none;}
input{
  padding:8px;
  border-radius:6px;
  border:none;
}
.modal{
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  background:rgba(0,0,0,0.6);
  display:flex;
  justify-content:center;
  align-items:center;
}
.modal-content{
  background:white;
  color:black;
  padding:25px;
  border-radius:10px;
}
</style>
</head>
<body>

<div class="container">
<h1>ğŸ›¡ Minecraft Work Manager</h1>

<input id="nickname" placeholder="ë‹‰ë„¤ì„ ì…ë ¥">
<br>
<button class="primary" onclick="checkIn()">ì¶œê·¼</button>
<button class="danger" onclick="checkOut()">í‡´ê·¼</button>
<button class="adminBtn" onclick="openAdmin()">ê´€ë¦¬</button>

<div class="card">
<h3>ê·¼ë¬´ ê¸°ë¡</h3>
<div id="log"></div>
</div>

<div id="adminPanel" class="card hidden">
<h2>ê´€ë¦¬ì íŒ¨ë„</h2>

<h3>ìœ ì € ê´€ë¦¬ (í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸)</h3>
<input id="newUser" placeholder="ë‹‰ë„¤ì„ ì…ë ¥">
<button onclick="addUser()">ìœ ì € ì¶”ê°€</button>
<button onclick="removeUser()">ìœ ì € ì‚­ì œ</button>

<h3>ê´€ë¦¬ì ê¶Œí•œ ë¶€ì—¬</h3>
<input id="adminUser" placeholder="ë‹‰ë„¤ì„ ì…ë ¥">
<button onclick="grantAdmin()">ê´€ë¦¬ì ë¶€ì—¬</button>

<h3>í†µê³„</h3>
<canvas id="statsChart"></canvas>

<button class="danger" onclick="clearAll()">ì „ì²´ ê¸°ë¡ ì‚­ì œ</button>
</div>

</div>

<div id="modal" class="modal hidden">
<div class="modal-content">
<p id="modalText"></p>
<button onclick="closeModal()">í™•ì¸</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAJ6MhR1JsGbvieb8akAi4Zpas_W3uaNJ4",
  authDomain: "dosep-b6ee3.firebaseapp.com",
  projectId: "dosep-b6ee3",
  storageBucket: "dosep-b6ee3.firebasestorage.app",
  messagingSenderId: "100096560571",
  appId: "1:100096560571:web:7eb2c1255835b6b57c889e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const DEFAULT_ADMIN = "LMSTD_23";

// ê¸°ë³¸ ê´€ë¦¬ì ìë™ ë“±ë¡
await setDoc(doc(db,"users",DEFAULT_ADMIN),{admin:true,whitelisted:true},{merge:true});

function showModal(text){
  document.getElementById("modalText").innerText=text;
  document.getElementById("modal").classList.remove("hidden");
}
window.closeModal=()=>document.getElementById("modal").classList.add("hidden");

async function isWhitelisted(name){
  const user = await getDoc(doc(db,"users",name));
  return user.exists() && user.data().whitelisted;
}

async function isAdmin(name){
  const user = await getDoc(doc(db,"users",name));
  return user.exists() && user.data().admin;
}

async function isWorking(name){
  const snap = await getDocs(collection(db,"worklogs"));
  let last=null;
  snap.forEach(d=>{
    if(d.data().nickname===name) last=d.data();
  });
  return last && last.type==="ì¶œê·¼";
}

window.checkIn=async()=>{
  const name=document.getElementById("nickname").value;
  if(!name) return showModal("ë‹‰ë„¤ì„ ì…ë ¥!");
  if(!(await isWhitelisted(name))) return showModal("ë“±ë¡ë˜ì§€ ì•Šì€ ìœ ì €ì…ë‹ˆë‹¤!");
  if(await isWorking(name)) return showModal("í‡´ê·¼ í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!");

  await addDoc(collection(db,"worklogs"),{
    nickname:name,
    type:"ì¶œê·¼",
    time:Date.now()
  });
  loadLogs();
};

window.checkOut=async()=>{
  const name=document.getElementById("nickname").value;
  if(!name) return showModal("ë‹‰ë„¤ì„ ì…ë ¥!");
  if(!(await isWhitelisted(name))) return showModal("ë“±ë¡ë˜ì§€ ì•Šì€ ìœ ì €ì…ë‹ˆë‹¤!");
  if(!(await isWorking(name))) return showModal("ì¶œê·¼ í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!");

  await addDoc(collection(db,"worklogs"),{
    nickname:name,
    type:"í‡´ê·¼",
    time:Date.now()
  });
  loadLogs();
};

async function loadLogs(){
  const snap=await getDocs(collection(db,"worklogs"));
  let html="";
  snap.forEach(d=>{
    const data=d.data();
    html+=`${data.nickname} - ${data.type} - ${new Date(data.time).toLocaleString()}<br>`;
  });
  document.getElementById("log").innerHTML=html;
}
loadLogs();

window.openAdmin=async()=>{
  const name=document.getElementById("nickname").value;
  if(!(await isAdmin(name))) return showModal("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
  document.getElementById("adminPanel").classList.remove("hidden");
  loadStats();
};

window.addUser=async()=>{
  const name=document.getElementById("newUser").value;
  await setDoc(doc(db,"users",name),{whitelisted:true,admin:false});
  showModal("ìœ ì € ë“±ë¡ ì™„ë£Œ");
};

window.removeUser=async()=>{
  const name=document.getElementById("newUser").value;
  await deleteDoc(doc(db,"users",name));
  showModal("ìœ ì € ì‚­ì œ ì™„ë£Œ");
};

window.grantAdmin=async()=>{
  const name=document.getElementById("adminUser").value;
  await setDoc(doc(db,"users",name),{admin:true,whitelisted:true},{merge:true});
  showModal("ê´€ë¦¬ì ë¶€ì—¬ ì™„ë£Œ");
};

window.clearAll=async()=>{
  const snap=await getDocs(collection(db,"worklogs"));
  snap.forEach(async d=>{
    await deleteDoc(doc(db,"worklogs",d.id));
  });
  showModal("ì „ì²´ ì‚­ì œ ì™„ë£Œ");
  loadLogs();
};

async function loadStats(){
  const snap=await getDocs(collection(db,"worklogs"));
  let dataMap={};

  snap.forEach(d=>{
    const data=d.data();
    if(!dataMap[data.nickname]) dataMap[data.nickname]=[];
    dataMap[data.nickname].push(data);
  });

  let labels=[];
  let avgHours=[];

  for(let user in dataMap){
    let logs=dataMap[user];
    let total=0;
    let sessions=0;

    for(let i=0;i<logs.length-1;i++){
      if(logs[i].type==="ì¶œê·¼" && logs[i+1].type==="í‡´ê·¼"){
        total+= (logs[i+1].time - logs[i].time);
        sessions++;
      }
    }

    if(sessions>0){
      labels.push(user);
      avgHours.push((total/sessions/3600000).toFixed(2));
    }
  }

  new Chart(document.getElementById("statsChart"),{
    type:"bar",
    data:{
      labels:labels,
      datasets:[{
        label:"í‰ê·  ê·¼ë¬´ì‹œê°„ (ì‹œê°„)",
        data:avgHours,
        backgroundColor:"rgba(0,255,200,0.7)"
      }]
    }
  });
}

</script>
</body>
</html>
